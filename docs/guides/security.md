# Security Guide for Instagram Carousel Generator API

This document outlines the security features implemented in the Instagram Carousel Generator API and provides guidance on secure usage.

## Security Features

### 1. API Key Authentication

All API endpoints (except `/health`) require API key authentication to prevent unauthorized access.

- **Header-based authentication**: Include the API key in the `X-API-Key` header
  ```
  X-API-Key: your-api-key-here
  ```

- **Query parameter authentication**: Include the API key as a query parameter
  ```
  ?api_key=your-api-key-here
  ```

Example with curl:
```bash
curl -H "X-API-Key: your-api-key" https://api.kitwanaakil.com/api/v1/generate-carousel
```

### 2. Rate Limiting

The API implements rate limiting to prevent abuse and ensure fair usage:

- **Standard endpoints**: 100 requests per minute per IP address by default
- **Resource-intensive endpoints**: 20 requests per minute per IP address
  - `/api/v1/generate-carousel`
  - `/api/v1/generate-carousel-with-urls`

When a rate limit is exceeded, the API returns a `429 Too Many Requests` status code.

### 3. File Access Security

File access is protected against directory traversal and unauthorized access:

- Carousel IDs must consist of alphanumeric characters, hyphens, and underscores only
- Filenames must follow a safe pattern and can't contain path traversal sequences like `../`
- Files can only be accessed for carousels that were generated by the requesting user (when API key authentication is enabled)

### 4. Security Headers

The API automatically adds security headers to all responses:

- `X-Content-Type-Options: nosniff` - Prevents MIME type sniffing
- `X-XSS-Protection: 1; mode=block` - Enables browser XSS protection
- `Strict-Transport-Security` - Enforces HTTPS usage (production only)

### 5. CORS Configuration

Cross-Origin Resource Sharing (CORS) is configurable to restrict which domains can access the API:

- In development mode, the default is to allow all origins (`*`)
- In production, it's recommended to restrict origins to specific domains

## Security Best Practices

### For API Users

1. **Protect your API key**:
   - Store API keys securely and never expose them in client-side code
   - Use environment variables in your applications
   - Rotate keys periodically and immediately if compromised

2. **Use HTTPS**:
   - Always access the API over HTTPS, never HTTP
   - Verify SSL certificates to prevent man-in-the-middle attacks

3. **Implement proper error handling**:
   - Handle rate limit responses (HTTP 429) with exponential backoff
   - Check for authentication errors and handle them gracefully

4. **Clean up temporary files**:
   - Files generated by the API are automatically deleted after the configured lifetime
   - For sensitive data, consider using the cleanup endpoint to delete files immediately after use

### For API Administrators

1. **API Key Configuration**:
   - Generate a strong API key (minimum 32 characters) for production
   - ```bash
     python -c "import secrets; print(secrets.token_urlsafe(32))"
     ```
   - Set the API key in the environment configuration

2. **CORS Configuration**:
   - In production, explicitly set `ALLOW_ORIGINS` to a comma-separated list of trusted domains
   - Avoid using wildcard `*` in production

3. **Rate Limit Configuration**:
   - Adjust rate limits based on expected usage patterns
   - Consider implementing stricter limits for resource-intensive endpoints

4. **Logging and Monitoring**:
   - Monitor failed authentication attempts
   - Track rate limit violations
   - Set up alerts for suspicious activities

## Implementation Details

### API Key Authentication

```python
def get_api_key(
    api_key_header: str = Security(api_key_header),
    api_key_query: str = Security(api_key_query),
) -> bool:
    # If no API key is configured, don't enforce authentication
    if not settings.API_KEY:
        return True
        
    # Try to get API key from header or query parameter
    api_key = api_key_header or api_key_query
    
    if api_key == settings.API_KEY:
        return True
        
    raise HTTPException(
        status_code=HTTP_403_FORBIDDEN, 
        detail="Invalid or missing API key"
    )
```

### Rate Limiting

```python
def rate_limit(max_requests: int = 100, window_seconds: int = 60) -> Callable:
    async def rate_limit_dependency(request: Request) -> None:
        # Get client IP
        client_host = request.client.host if request.client else "unknown"
        
        # Get current time
        now = time.time()
        
        # Initialize record for this client
        if client_host not in request_records:
            request_records[client_host] = []
        
        # Clean up old records
        request_records[client_host] = [
            timestamp for timestamp in request_records[client_host]
            if now - timestamp < window_seconds
        ]
        
        # Check if rate limit is exceeded
        if len(request_records[client_host]) >= max_requests:
            raise HTTPException(
                status_code=HTTP_429_TOO_MANY_REQUESTS,
                detail=f"Rate limit exceeded: {max_requests} requests per {window_seconds} seconds"
            )
            
        # Add current request timestamp
        request_records[client_host].append(now)
    
    return rate_limit_dependency
```

### File Access Validation

```python
def validate_file_access(carousel_id: str, filename: str) -> None:
    # Validate carousel_id format (alphanumeric only)
    if not re.match(r'^[a-zA-Z0-9-_]+$', carousel_id):
        raise HTTPException(status_code=404, detail="Invalid carousel ID format")
    
    # Validate filename format (prevent path traversal)
    if not re.match(r'^[a-zA-Z0-9-_]+\.[a-zA-Z0-9]+$', filename):
        raise HTTPException(status_code=404, detail="Invalid filename format")
    
    # Ensure filename doesn't contain path traversal attempts
    if '..' in filename or '/' in filename:
        raise HTTPException(status_code=403, detail="Invalid file access")
```

## Common Security Questions

### Q: Is the API secure enough for production use?
A: Yes, with proper configuration. Ensure you set a strong API key, configure CORS properly, and serve the API over HTTPS.

### Q: Are uploaded images and generated carousels secure?
A: Files are stored temporarily and access is validated to prevent unauthorized access. For highly sensitive content, consider implementing additional security measures.

### Q: How can I further enhance security?
A: Consider adding a Web Application Firewall (WAF), implementing OAuth2 authentication for multi-user scenarios, or using a reverse proxy like Nginx with additional security configurations.

### Q: What if the API key is compromised?
A: Immediately generate a new API key and update your environment configuration. Monitor logs for unauthorized access.

## Security Contact

If you discover a security vulnerability, please contact us directly at [security@kitwanaakil.com](mailto:security@kitwanaakil.com) rather than using the issue tracker.